<html>

<head>
<title>JavaScript Replace</title>

</head>

<body>
branch
<p id="showinf"></p>
<p>***快速取代功能***</p>

輸入取代參數並且請上傳文件。

     <p>舊字:<input type="text" name="oldw"  id="OldWord" size="20">
	    新字:<input type="text" name="neww"  id="NewWord" size="20">
	<p>是否引用單字置換規則:<input type="checkbox" id="isword"><p>
	 <input type="button" name="addbutton" id="addReplaceButton" value="新增一筆置換條件" onclick="addshowItem()"></p>
	  置換條件視窗:<p><textarea  id="replaceItem"  cols="68" rows="10" ></textarea><p>
	  <p>首部有加星號代表適用單字規則<p>
	  移除第
	  <input type="text" name="deli"  id="delnumber" >
	 <input type="button" name="deleteButton" id="deleteButton" value="條置換條件" onclick="delitem()"></p>
	 
     <p>文件: <input id="MyFileTxt"  type="file"     /></p>
	<p> <input type="button" name="generateRepPrew" id="generateRepPrew" value="產生預覽" onclick="genPreview()">
     <input type="button" name="generateDownload" id="downloadButton" value="產生下載連結" onclick="genDownload()"></p>
	原始文件:<p><textarea  id="filePreview" cols="68" rows="10"  ></textarea><p>
	預覽文件:<p><textarea  id="repPreview" cols="68" rows="10"  ></textarea>
 <!--   <input type="button" name="testbtn" id="TESTBTN" value="TEST" onclick="TEST()">-->
    
     








</body>


 <script language="JavaScript">
 var originalItemArray=[];
 var replaceItemArray=[];
 var wordItemArray=[];
 var isReplacement=false;
 
 var proptext;
 
 var replaceText;
 
    window.onload = function () {
    document.getElementById('MyFileTxt').onchange = readFile;
	
};

function readFile() {
    
    var fReader = new FileReader();           
    fReader.onload = function (event) {
        document.getElementById('filePreview').value = event.target.result;
		
			proptext=event.target.result;
		
		
    };
     fReader.readAsText(this.files[0]);
    
    }
function doreplace(oristr,oriarr_,reparr_,fcarr_){
	    for(var i=0;i<oriarr_.length;i++){
		
			
			
			if(fcarr_[i]==true){
				//word rule tale
					//_word_
					oristr=	simpleReplace(oristr," "+oriarr_[i]+" "," "+reparr_[i]+" ");
					//_word.
					oristr=	simpleReplace(oristr,(" "+oriarr_[i]+". "),(" "+reparr_[i]+". "));
					//_word!
					oristr=	simpleReplace(oristr," "+oriarr_[i]+"\!"," "+reparr_[i]+"\!");
					//_word,
					oristr=	simpleReplace(oristr," "+oriarr_[i]+"\,"," "+reparr_[i]+"\,");
					//_word?
					oristr=	simpleReplace(oristr," "+oriarr_[i]+"? "," "+reparr_[i]+"? ");
					//_word:
					oristr=	simpleReplace(oristr," "+oriarr_[i]+"\:"," "+reparr_[i]+"\:");
					

					//Word_ capcase
					oristr=	simpleReplace(oristr,toTitleCase(oriarr_[i])+" ",toTitleCase(reparr_[i])+" ");
					//_Word_ capcase
					
					//_Word.
					oristr=	simpleReplace(oristr," "+toTitleCase(oriarr_[i])+"."," "+toTitleCase(reparr_[i])+".");
				
				
			}
			else oristr=	simpleReplace(oristr,oriarr_[i],reparr_[i]);
			
			
			
		}
			
		
		 
		 
		 
	return oristr;
	}
	
function simpleReplace(contx_,ori_,rep_){
	var oreg = new RegExp(ori_, 'g');
	contx_ =contx_.replace(oreg,rep_);
	return contx_;
}

function toTitleCase(str)
{
    return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
}

function addshowItem(){
	
	
	//check isword
	var isword_bool=document.getElementById("isword").checked ;
	document.getElementById("isword").checked=false;
	
	
	//init new old word and clear
	var repa="";
	var repb="";
	repa=document.getElementById('OldWord').value;
	repb=document.getElementById('NewWord').value; 
	if(repa==""&&repb=="") return;
	document.getElementById('OldWord').value =null;
	document.getElementById('NewWord').value =null;
	//process item
		//	alert(isword_bool);
	wordItemArray.push(Boolean(isword_bool));
	originalItemArray.push(repa);
	replaceItemArray.push(repb);
	 //show in board
	 showItem();
	}
function showItem(){
var showstr="";
	 isReplacement=false;
	   for(var i=0;i<replaceItemArray.length;i++){
	     
        if(i=="0")showstr+="1";
		else showstr+=(i+1);
	   showstr+=" . ";
	   if(wordItemArray[i]==true)showstr+="*";
	   
	   showstr+=(originalItemArray[i]);
	   showstr+=(" => ");
	   showstr+=(replaceItemArray[i]);
	   showstr+=(" \n");
	   }
	 
	 document.getElementById('replaceItem').value =showstr;
}	
function genPreview(){
	replaceText=doreplace(proptext,originalItemArray,replaceItemArray,wordItemArray);
         isReplacement=true;
		document.getElementById('repPreview').value = replaceText;
}
	
function genDownload(){
       if( isReplacement== false) 
	   {
	   genPreview();
	   
	   
	   }
	   
	var tmpstr=document.getElementById('MyFileTxt').value;
	   var tfn=tmpstr.split("\\");
	   
	   //window.alert(tfn[tfn.length-1]);
	   download("rep_"+tfn[tfn.length-1],replaceText);
	return;
}
function delitem(){

	var  delnum= document.getElementById('delnumber').value;
	document.getElementById('delnumber').value=null;
	delnum=(delnum-1);
	
	if(delnum >=0 && delnum<originalItemArray.length){
		originalItemArray.splice(delnum,1);
		replaceItemArray.splice(delnum,1);
		wordItemArray.splice(delnum,1);
		
	}
	else{
		alert("不正確的引數!");
		return;
	}
	showItem();
}	
function TEST(){
	download("sam.txt",proptext);
}

function download(filename, text) {
	var element = document.createElement('a');
	element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
	element.setAttribute('download', filename);

	element.style.display = 'none';
	document.body.appendChild(element);

	element.click();

	document.body.removeChild(element);
}

  </script> 


</html>